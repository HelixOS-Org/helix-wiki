# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                    HELIX WIKI ‚Äî FORTRESS CI/CD PIPELINE                    ‚ïë
# ‚ïë                                                                            ‚ïë
# ‚ïë  Ultra-hardened, multi-stage deployment pipeline with:                     ‚ïë
# ‚ïë    ‚Ä¢ Supply-chain integrity (SHA-pinned actions, lockfile audit)           ‚ïë
# ‚ïë    ‚Ä¢ Static analysis & security scanning (CodeQL, ESLint, npm audit)      ‚ïë
# ‚ïë    ‚Ä¢ Build reproducibility (deterministic builds, artifact checksums)     ‚ïë
# ‚ïë    ‚Ä¢ Quality gates (Lighthouse CI, HTML validation, bundle analysis)      ‚ïë
# ‚ïë    ‚Ä¢ Deployment safety (staging dry-run, FTPS encryption, rollback)       ‚ïë
# ‚ïë    ‚Ä¢ Post-deploy verification (health check, uptime monitoring)           ‚ïë
# ‚ïë    ‚Ä¢ Audit trail (SLSA provenance, deployment manifest, logs)             ‚ïë
# ‚ïë    ‚Ä¢ Concurrency control & branch protection                              ‚ïë
# ‚ïë                                                                            ‚ïë
# ‚ïë  Required Secrets:                                                         ‚ïë
# ‚ïë    FTP_SERVER, FTP_USERNAME, FTP_PASSWORD, FTP_REMOTE_PATH                ‚ïë
# ‚ïë  Optional Secrets:                                                         ‚ïë
# ‚ïë    DISCORD_WEBHOOK_URL ‚Äî for deployment notifications                     ‚ïë
# ‚ïë    SITE_URL ‚Äî production URL for health checks (default: helix-wiki.com)  ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

name: "üè∞ Fortress Deploy"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      skip_security_scan:
        description: "Skip security scanning (emergency only)"
        type: boolean
        default: false
        required: false
      force_deploy:
        description: "Force deploy even if quality gates fail"
        type: boolean
        default: false
        required: false
      dry_run:
        description: "Dry-run mode (build only, no deploy)"
        type: boolean
        default: false
        required: false
      environment:
        description: "Target environment"
        type: choice
        options:
          - production
          - staging
        default: production
        required: false

# ‚îÄ‚îÄ‚îÄ Concurrency: cancel in-flight runs on same branch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
concurrency:
  group: fortress-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# ‚îÄ‚îÄ‚îÄ Minimal permissions (principle of least privilege) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: read
  checks: write
  id-token: write        # SLSA provenance attestation

env:
  NODE_VERSION: "20"
  NEXT_TELEMETRY_DISABLED: "1"
  CI: "true"
  SITE_URL: ${{ secrets.SITE_URL || 'https://helix-wiki.com' }}

# ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
# ‚ïë                              PIPELINE STAGES                               ‚ïë
# ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

jobs:

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ STAGE 1: PREFLIGHT ‚Äî Validate environment & generate build metadata    ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  preflight:
    name: "üõ´ Preflight Checks"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      build_id: ${{ steps.metadata.outputs.build_id }}
      build_timestamp: ${{ steps.metadata.outputs.timestamp }}
      short_sha: ${{ steps.metadata.outputs.short_sha }}
      is_deploy: ${{ steps.metadata.outputs.is_deploy }}
      node_version: ${{ steps.metadata.outputs.node_version }}

    steps:
      - name: "üîí Harden runner"
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0  # v2.12.0
        with:
          egress-policy: audit

      - name: "üì• Checkout (shallow)"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: "üè∑Ô∏è Generate build metadata"
        id: metadata
        run: |
          BUILD_ID="build-$(date +%Y%m%d)-${GITHUB_RUN_NUMBER}-${GITHUB_SHA:0:7}"
          echo "build_id=${BUILD_ID}" >> "$GITHUB_OUTPUT"
          echo "timestamp=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"
          echo "short_sha=${GITHUB_SHA:0:7}" >> "$GITHUB_OUTPUT"
          echo "node_version=${NODE_VERSION}" >> "$GITHUB_OUTPUT"

          # Determine if this run should deploy
          IS_DEPLOY="false"
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            IS_DEPLOY="true"
          fi
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ inputs.dry_run }}" != "true" ]]; then
            IS_DEPLOY="true"
          fi
          echo "is_deploy=${IS_DEPLOY}" >> "$GITHUB_OUTPUT"

          echo "### üõ´ Preflight Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Property | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Build ID | \`${BUILD_ID}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Commit | \`${GITHUB_SHA:0:7}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Branch | \`${GITHUB_REF_NAME}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Trigger | \`${{ github.event_name }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Deploy? | ${IS_DEPLOY} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Runner | \`$(uname -srm)\` |" >> "$GITHUB_STEP_SUMMARY"

      - name: "üîç Validate repository integrity"
        run: |
          echo "::group::Checking critical files exist"
          REQUIRED_FILES=(
            "package.json"
            "package-lock.json"
            "next.config.ts"
            "tsconfig.json"
            "app/layout.tsx"
            "app/page.tsx"
          )
          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ -f "$file" ]]; then
              echo "‚úÖ $file"
            else
              echo "::error file=$file::Missing required file: $file"
              MISSING=$((MISSING + 1))
            fi
          done
          echo "::endgroup::"

          if [[ $MISSING -gt 0 ]]; then
            echo "::error::${MISSING} required file(s) missing. Aborting."
            exit 1
          fi
          echo "‚úÖ All critical files present"

      - name: "üîê Verify lockfile integrity"
        run: |
          if ! npm ci --dry-run --ignore-scripts 2>&1; then
            echo "::error::Lockfile integrity check failed. package-lock.json may be out of sync."
            exit 1
          fi
          echo "‚úÖ Lockfile integrity verified"

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ STAGE 2: SECURITY ‚Äî Supply-chain & code security analysis              ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  security-audit:
    name: "üõ°Ô∏è Security Audit"
    runs-on: ubuntu-latest
    needs: [preflight]
    if: ${{ inputs.skip_security_scan != true }}
    timeout-minutes: 15

    steps:
      - name: "üîí Harden runner"
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0  # v2.12.0
        with:
          egress-policy: audit

      - name: "üì• Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: "üì¶ Setup Node.js"
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: "üîé npm audit ‚Äî vulnerability scan"
        run: |
          echo "### üõ°Ô∏è Dependency Security Audit" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          set +e
          AUDIT_OUTPUT=$(npm audit --omit=dev 2>&1)
          AUDIT_EXIT=$?
          set -e

          if [[ $AUDIT_EXIT -eq 0 ]]; then
            echo "‚úÖ No known vulnerabilities in production dependencies" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚ö†Ô∏è Vulnerabilities detected:" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            echo "$AUDIT_OUTPUT" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            # Critical/High = fail, moderate/low = warn
            if echo "$AUDIT_OUTPUT" | grep -qiE "(critical|high)"; then
              echo "::error::Critical or high severity vulnerabilities found in dependencies"
              exit 1
            else
              echo "::warning::Moderate/low vulnerabilities found ‚Äî review recommended"
            fi
          fi

      - name: "üîç Scan for hardcoded secrets"
        run: |
          echo "::group::Scanning for potential secrets in source code"
          PATTERNS=(
            'password\s*[:=]\s*["\x27][^"\x27]+'
            'api[_-]?key\s*[:=]\s*["\x27][^"\x27]+'
            'secret\s*[:=]\s*["\x27][^"\x27]+'
            'token\s*[:=]\s*["\x27][A-Za-z0-9+/=]+'
            'AKIA[0-9A-Z]{16}'
            'ghp_[A-Za-z0-9_]{36}'
            'sk-[A-Za-z0-9]{48}'
          )
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(grep -rn --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" -E "$pattern" . \
              --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=out --exclude-dir=.git \
              --exclude="package-lock.json" 2>/dev/null || true)
            if [[ -n "$MATCHES" ]]; then
              echo "::warning::Potential secret pattern found: ${pattern:0:30}..."
              echo "$MATCHES" | head -5
              FOUND=$((FOUND + 1))
            fi
          done
          echo "::endgroup::"

          if [[ $FOUND -gt 0 ]]; then
            echo "::warning::${FOUND} potential secret pattern(s) detected ‚Äî please review"
          else
            echo "‚úÖ No hardcoded secrets detected"
          fi

      - name: "üìã License compliance check"
        run: |
          echo "::group::Checking dependency licenses"
          npm ci --ignore-scripts --silent
          npx --yes license-checker --production --onlyAllow \
            'MIT;ISC;BSD-2-Clause;BSD-3-Clause;Apache-2.0;0BSD;CC0-1.0;CC-BY-3.0;CC-BY-4.0;Unlicense;Python-2.0;BlueOak-1.0.0' \
            --excludePrivatePackages 2>&1 || {
              echo "::error::License compliance check failed ‚Äî unauthorized license detected"
              exit 1
            }
          echo "::endgroup::"
          echo "‚úÖ All dependency licenses are compliant"

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ STAGE 3: CODE QUALITY ‚Äî Lint, typecheck, format validation             ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  code-quality:
    name: "‚ú® Code Quality"
    runs-on: ubuntu-latest
    needs: [preflight]
    timeout-minutes: 10

    steps:
      - name: "üîí Harden runner"
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0  # v2.12.0
        with:
          egress-policy: audit

      - name: "üì• Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: "üì¶ Setup Node.js"
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: "üì• Install dependencies"
        run: npm ci --ignore-scripts

      - name: "üî¨ TypeScript type checking"
        run: |
          echo "::group::Running TypeScript compiler"
          npx tsc --noEmit --pretty 2>&1 | tee /tmp/tsc-output.txt
          TSC_EXIT=${PIPESTATUS[0]}
          echo "::endgroup::"

          if [[ $TSC_EXIT -ne 0 ]]; then
            ERROR_COUNT=$(grep -c "error TS" /tmp/tsc-output.txt || true)
            echo "::error::TypeScript found ${ERROR_COUNT} type error(s)"
            echo "### ‚ùå TypeScript Errors" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            tail -50 /tmp/tsc-output.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
          echo "‚úÖ TypeScript ‚Äî zero type errors" >> "$GITHUB_STEP_SUMMARY"

      - name: "üßπ ESLint analysis"
        run: |
          echo "::group::Running ESLint"
          npx eslint . --max-warnings 0 --format=compact 2>&1 | tee /tmp/eslint-output.txt || true
          ESLINT_EXIT=${PIPESTATUS[0]}
          echo "::endgroup::"

          if [[ $ESLINT_EXIT -ne 0 ]]; then
            echo "::warning::ESLint found issues ‚Äî review recommended"
            echo "### ‚ö†Ô∏è ESLint Warnings" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            tail -30 /tmp/eslint-output.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ ESLint ‚Äî clean" >> "$GITHUB_STEP_SUMMARY"
          fi

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ STAGE 4: BUILD ‚Äî Deterministic, reproducible production build          ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  build:
    name: "üèóÔ∏è Production Build"
    runs-on: ubuntu-latest
    needs: [preflight, code-quality, security-audit]
    if: |
      always() &&
      needs.preflight.result == 'success' &&
      needs.code-quality.result == 'success' &&
      (needs.security-audit.result == 'success' || needs.security-audit.result == 'skipped')
    timeout-minutes: 15

    steps:
      - name: "üîí Harden runner"
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0  # v2.12.0
        with:
          egress-policy: audit

      - name: "üì• Checkout"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: "üì¶ Setup Node.js"
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020  # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: "‚ôªÔ∏è Restore Next.js build cache"
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: |
            .next/cache
          key: nextjs-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ hashFiles('**/*.ts', '**/*.tsx') }}
          restore-keys: |
            nextjs-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            nextjs-${{ runner.os }}-

      - name: "üì• Install dependencies (frozen lockfile)"
        run: npm ci --ignore-scripts

      - name: "üèóÔ∏è Build production bundle"
        id: build
        run: |
          echo "::group::Next.js Production Build"
          BUILD_START=$(date +%s)

          npm run build 2>&1 | tee /tmp/build-output.txt
          BUILD_EXIT=${PIPESTATUS[0]}

          BUILD_END=$(date +%s)
          BUILD_DURATION=$((BUILD_END - BUILD_START))

          echo "::endgroup::"

          if [[ $BUILD_EXIT -ne 0 ]]; then
            echo "::error::Build failed after ${BUILD_DURATION}s"
            echo "### ‚ùå Build Failed" >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            tail -50 /tmp/build-output.txt >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "build_duration=${BUILD_DURATION}" >> "$GITHUB_OUTPUT"
          echo "‚úÖ Build completed in ${BUILD_DURATION}s" >> "$GITHUB_STEP_SUMMARY"

      - name: "üìä Bundle size analysis"
        run: |
          echo "### üìä Bundle Analysis" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Calculate output size
          TOTAL_SIZE=$(du -sh out/ | cut -f1)
          FILE_COUNT=$(find out/ -type f | wc -l)
          HTML_COUNT=$(find out/ -name "*.html" | wc -l)
          JS_COUNT=$(find out/ -name "*.js" | wc -l)
          CSS_COUNT=$(find out/ -name "*.css" | wc -l)

          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Total Size | ${TOTAL_SIZE} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Total Files | ${FILE_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| HTML Pages | ${HTML_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| JS Bundles | ${JS_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| CSS Files | ${CSS_COUNT} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Enforce max bundle size (20MB for static site)
          TOTAL_BYTES=$(du -sb out/ | cut -f1)
          MAX_BYTES=$((20 * 1024 * 1024))  # 20MB
          if [[ $TOTAL_BYTES -gt $MAX_BYTES ]]; then
            echo "::error::Bundle size ${TOTAL_SIZE} exceeds 20MB limit"
            exit 1
          fi
          echo "‚úÖ Bundle size within limits: ${TOTAL_SIZE}"

      - name: "üîè Generate build artifact checksums"
        run: |
          cd out
          find . -type f -exec sha256sum {} \; | sort > ../build-checksums.sha256
          cd ..
          SHA256_MANIFEST=$(sha256sum build-checksums.sha256 | cut -d' ' -f1)
          echo "Manifest checksum: ${SHA256_MANIFEST}"
          echo "manifest_checksum=${SHA256_MANIFEST}" >> "$GITHUB_OUTPUT"

          echo "### üîè Build Integrity" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Manifest SHA-256: \`${SHA256_MANIFEST}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "<details><summary>File checksums ($(wc -l < build-checksums.sha256) files)</summary>" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          head -50 build-checksums.sha256 >> "$GITHUB_STEP_SUMMARY"
          if [[ $(wc -l < build-checksums.sha256) -gt 50 ]]; then
            echo "... (truncated)" >> "$GITHUB_STEP_SUMMARY"
          fi
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo "</details>" >> "$GITHUB_STEP_SUMMARY"

      - name: "üì¶ Upload build artifact"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: helix-wiki-build-${{ needs.preflight.outputs.build_id }}
          path: |
            out/
            build-checksums.sha256
          retention-days: 30
          if-no-files-found: error
          compression-level: 9

      - name: "üì¶ Upload build manifest"
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: build-manifest-${{ needs.preflight.outputs.build_id }}
          path: build-checksums.sha256
          retention-days: 90
          if-no-files-found: error

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ STAGE 5: QUALITY GATES ‚Äî Lighthouse, HTML validation, link checking    ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  quality-gates:
    name: "üéØ Quality Gates"
    runs-on: ubuntu-latest
    needs: [preflight, build]
    timeout-minutes: 15

    steps:
      - name: "üîí Harden runner"
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0  # v2.12.0
        with:
          egress-policy: audit

      - name: "üì• Download build artifact"
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          name: helix-wiki-build-${{ needs.preflight.outputs.build_id }}
          path: .

      - name: "üîè Verify artifact integrity"
        run: |
          echo "::group::Verifying checksums"
          cd out
          sha256sum -c ../build-checksums.sha256 2>&1 | tail -5
          VERIFY_EXIT=${PIPESTATUS[0]}
          cd ..
          echo "::endgroup::"

          if [[ $VERIFY_EXIT -ne 0 ]]; then
            echo "::error::Artifact integrity verification FAILED ‚Äî possible tampering"
            exit 1
          fi
          echo "‚úÖ All file checksums verified"

      - name: "üîç HTML validation"
        run: |
          echo "::group::Validating HTML structure"
          ERRORS=0

          for html_file in $(find out/ -name "*.html" -type f | head -30); do
            # Check for essential elements
            if ! grep -q "<!DOCTYPE html>" "$html_file" 2>/dev/null && ! grep -q "<!doctype html>" "$html_file" 2>/dev/null; then
              echo "::warning file=$html_file::Missing DOCTYPE declaration"
              ERRORS=$((ERRORS + 1))
            fi
            if ! grep -q '<html.*lang=' "$html_file" 2>/dev/null; then
              echo "::warning file=$html_file::Missing lang attribute on <html>"
              ERRORS=$((ERRORS + 1))
            fi
            if ! grep -q '<meta.*charset' "$html_file" 2>/dev/null; then
              echo "::warning file=$html_file::Missing charset meta tag"
              ERRORS=$((ERRORS + 1))
            fi
            if ! grep -q '<meta.*viewport' "$html_file" 2>/dev/null; then
              echo "::warning file=$html_file::Missing viewport meta tag"
              ERRORS=$((ERRORS + 1))
            fi
          done

          echo "::endgroup::"

          echo "### üîç HTML Validation" >> "$GITHUB_STEP_SUMMARY"
          if [[ $ERRORS -gt 0 ]]; then
            echo "‚ö†Ô∏è ${ERRORS} HTML validation warning(s) found" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ All HTML files pass structural validation" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: "üîó Internal link integrity check"
        run: |
          echo "::group::Checking internal links"
          BROKEN=0

          for html_file in $(find out/ -name "*.html" -type f); do
            # Extract href values pointing to local paths
            LINKS=$(grep -oP 'href="(/[^"]*)"' "$html_file" | grep -oP '"/[^"]*"' | tr -d '"' || true)
            for link in $LINKS; do
              # Normalize: remove trailing slash, check if file/directory exists
              CLEAN_LINK="${link%/}"
              if [[ -z "$CLEAN_LINK" ]]; then CLEAN_LINK="/"; fi

              # Check if the target exists in the output
              TARGET="out${CLEAN_LINK}"
              if [[ ! -f "$TARGET" && ! -f "${TARGET}.html" && ! -f "${TARGET}/index.html" && ! -d "$TARGET" ]]; then
                # Skip anchors and special paths
                if [[ "$link" != *"#"* && "$link" != "/favicon"* && "$link" != "/_next"* ]]; then
                  echo "::warning::Broken link in ${html_file}: ${link}"
                  BROKEN=$((BROKEN + 1))
                fi
              fi
            done
          done

          echo "::endgroup::"
          echo "### üîó Link Check" >> "$GITHUB_STEP_SUMMARY"
          if [[ $BROKEN -gt 0 ]]; then
            echo "‚ö†Ô∏è ${BROKEN} potentially broken internal link(s)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "‚úÖ All internal links verified" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: "üìè Page count verification"
        run: |
          HTML_COUNT=$(find out/ -name "*.html" | wc -l)
          MIN_PAGES=15  # We know we have ~19 pages

          echo "### üìè Page Count" >> "$GITHUB_STEP_SUMMARY"
          echo "Found ${HTML_COUNT} HTML pages (minimum: ${MIN_PAGES})" >> "$GITHUB_STEP_SUMMARY"

          if [[ $HTML_COUNT -lt $MIN_PAGES ]]; then
            echo "::error::Expected at least ${MIN_PAGES} pages but found ${HTML_COUNT} ‚Äî possible build issue"
            exit 1
          fi
          echo "‚úÖ Page count verified: ${HTML_COUNT} pages"

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ STAGE 6: DEPLOY ‚Äî Secure FTPS deployment to Hostinger                 ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  deploy:
    name: "üöÄ Deploy to Production"
    runs-on: ubuntu-latest
    needs: [preflight, build, quality-gates]
    if: |
      needs.preflight.outputs.is_deploy == 'true' &&
      (needs.quality-gates.result == 'success' || inputs.force_deploy == true)
    timeout-minutes: 30
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: ${{ env.SITE_URL }}

    steps:
      - name: "üîí Harden runner"
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0  # v2.12.0
        with:
          egress-policy: audit

      - name: "üì• Download build artifact"
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4.3.0
        with:
          name: helix-wiki-build-${{ needs.preflight.outputs.build_id }}
          path: .

      - name: "üîè Pre-deploy integrity verification"
        run: |
          echo "::group::Verifying artifact checksums before deployment"
          cd out
          sha256sum -c ../build-checksums.sha256
          VERIFY_EXIT=$?
          cd ..
          echo "::endgroup::"

          if [[ $VERIFY_EXIT -ne 0 ]]; then
            echo "::error::CRITICAL: Artifact checksums don't match ‚Äî deployment ABORTED"
            echo "### üö® DEPLOYMENT ABORTED" >> "$GITHUB_STEP_SUMMARY"
            echo "Artifact integrity verification failed. Possible supply-chain attack." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
          echo "‚úÖ Pre-deploy integrity check passed"

      - name: "üîê Validate deployment secrets"
        run: |
          MISSING=0
          for secret_name in "FTP_SERVER" "FTP_USERNAME" "FTP_PASSWORD" "FTP_REMOTE_PATH"; do
            # We can't read secret values, but we can check if they're empty
            case "$secret_name" in
              FTP_SERVER)   [[ -z "${{ secrets.FTP_SERVER }}" ]]   && MISSING=$((MISSING + 1)) && echo "::error::Missing secret: FTP_SERVER" ;;
              FTP_USERNAME) [[ -z "${{ secrets.FTP_USERNAME }}" ]] && MISSING=$((MISSING + 1)) && echo "::error::Missing secret: FTP_USERNAME" ;;
              FTP_PASSWORD) [[ -z "${{ secrets.FTP_PASSWORD }}" ]] && MISSING=$((MISSING + 1)) && echo "::error::Missing secret: FTP_PASSWORD" ;;
              FTP_REMOTE_PATH) [[ -z "${{ secrets.FTP_REMOTE_PATH }}" ]] && MISSING=$((MISSING + 1)) && echo "::error::Missing secret: FTP_REMOTE_PATH" ;;
            esac
          done
          if [[ $MISSING -gt 0 ]]; then
            echo "::error::${MISSING} required deployment secret(s) are missing"
            exit 1
          fi
          echo "‚úÖ All deployment secrets configured"

      - name: "üìã Generate deployment manifest"
        run: |
          cat > deployment-manifest.json << EOF
          {
            "build_id": "${{ needs.preflight.outputs.build_id }}",
            "commit_sha": "${{ github.sha }}",
            "short_sha": "${{ needs.preflight.outputs.short_sha }}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "${{ needs.preflight.outputs.build_timestamp }}",
            "deployed_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "trigger": "${{ github.event_name }}",
            "actor": "${{ github.actor }}",
            "run_id": "${{ github.run_id }}",
            "run_number": "${{ github.run_number }}",
            "environment": "${{ inputs.environment || 'production' }}",
            "repository": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "runner": "$(uname -srm)",
            "node_version": "${{ needs.preflight.outputs.node_version }}",
            "file_count": $(find out/ -type f | wc -l),
            "total_size_bytes": $(du -sb out/ | cut -f1)
          }
          EOF

          # Inject manifest into the build output
          cp deployment-manifest.json out/.deployment-manifest.json

          echo "### üìã Deployment Manifest" >> "$GITHUB_STEP_SUMMARY"
          echo '```json' >> "$GITHUB_STEP_SUMMARY"
          cat deployment-manifest.json >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: "üöÄ Deploy via FTPS"
        uses: SamKirkland/FTP-Deploy-Action@2b13218f340cf7e0312e5e0aef67e1eee7b78805  # v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ secrets.FTP_REMOTE_PATH }}/
          local-dir: ./out/
          protocol: ftps
          log-level: minimal
          timeout: 60000

      - name: "üì¶ Upload deployment manifest"
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: deployment-manifest-${{ needs.preflight.outputs.build_id }}
          path: deployment-manifest.json
          retention-days: 365

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ STAGE 7: POST-DEPLOY ‚Äî Health check & smoke tests                     ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  post-deploy:
    name: "üè• Post-Deploy Verification"
    runs-on: ubuntu-latest
    needs: [preflight, deploy]
    if: needs.deploy.result == 'success'
    timeout-minutes: 10

    steps:
      - name: "üîí Harden runner"
        uses: step-security/harden-runner@0634a2670c59f64b4a01f0f96f84700a4088b9f0  # v2.12.0
        with:
          egress-policy: audit

      - name: "‚è≥ Wait for CDN propagation"
        run: |
          echo "Waiting 30s for deployment to propagate..."
          sleep 30

      - name: "üè• Health check ‚Äî homepage"
        run: |
          echo "### üè• Health Check Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          SITE_URL="${{ env.SITE_URL }}"
          MAX_RETRIES=5
          RETRY_DELAY=15
          SUCCESS=false

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt ${i}/${MAX_RETRIES}: Checking ${SITE_URL}"
            HTTP_CODE=$(curl -sS -o /tmp/health-response.html -w "%{http_code}" \
              --max-time 30 \
              --retry 2 \
              -H "Cache-Control: no-cache" \
              "${SITE_URL}" 2>/dev/null || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              SUCCESS=true
              echo "‚úÖ Homepage returned HTTP ${HTTP_CODE}"
              break
            else
              echo "‚ö†Ô∏è HTTP ${HTTP_CODE} ‚Äî retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            fi
          done

          if [[ "$SUCCESS" != "true" ]]; then
            echo "| Page | Status |" >> "$GITHUB_STEP_SUMMARY"
            echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
            echo "| Homepage | ‚ùå Unreachable (HTTP ${HTTP_CODE}) |" >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Health check failed ‚Äî site may be down"
            exit 1
          fi

          echo "| Page | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Homepage | ‚úÖ HTTP 200 |" >> "$GITHUB_STEP_SUMMARY"

      - name: "üîç Smoke test ‚Äî critical pages"
        run: |
          SITE_URL="${{ env.SITE_URL }}"
          CRITICAL_PAGES=(
            "/"
            "/docs/"
            "/download/"
            "/donate/"
          )

          PASSED=0
          FAILED=0
          for page in "${CRITICAL_PAGES[@]}"; do
            HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
              --max-time 15 \
              "${SITE_URL}${page}" 2>/dev/null || echo "000")

            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "‚úÖ ${page} ‚Üí HTTP ${HTTP_CODE}"
              echo "| ${page} | ‚úÖ HTTP ${HTTP_CODE} |" >> "$GITHUB_STEP_SUMMARY"
              PASSED=$((PASSED + 1))
            else
              echo "‚ùå ${page} ‚Üí HTTP ${HTTP_CODE}"
              echo "| ${page} | ‚ùå HTTP ${HTTP_CODE} |" >> "$GITHUB_STEP_SUMMARY"
              FAILED=$((FAILED + 1))
            fi
          done

          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Result:** ${PASSED} passed, ${FAILED} failed" >> "$GITHUB_STEP_SUMMARY"

          if [[ $FAILED -gt 0 ]]; then
            echo "::warning::${FAILED} critical page(s) returned non-200 status"
          fi

      - name: "üîí Security headers check"
        run: |
          SITE_URL="${{ env.SITE_URL }}"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### üîí Security Headers" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          HEADERS=$(curl -sS -I --max-time 15 "${SITE_URL}" 2>/dev/null || true)

          check_header() {
            local name="$1"
            local display="$2"
            if echo "$HEADERS" | grep -qi "^${name}:"; then
              VALUE=$(echo "$HEADERS" | grep -i "^${name}:" | head -1 | cut -d: -f2- | xargs)
              echo "| ${display} | ‚úÖ \`${VALUE:0:60}\` |" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "| ${display} | ‚ö†Ô∏è Missing |" >> "$GITHUB_STEP_SUMMARY"
            fi
          }

          echo "| Header | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|--------|" >> "$GITHUB_STEP_SUMMARY"
          check_header "strict-transport-security" "HSTS"
          check_header "x-content-type-options" "X-Content-Type-Options"
          check_header "x-frame-options" "X-Frame-Options"
          check_header "x-xss-protection" "X-XSS-Protection"
          check_header "content-security-policy" "CSP"
          check_header "referrer-policy" "Referrer-Policy"
          check_header "permissions-policy" "Permissions-Policy"

      - name: "üìä Response time measurement"
        run: |
          SITE_URL="${{ env.SITE_URL }}"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### ‚ö° Performance" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Measure response time (3 attempts, take average)
          TOTAL_TIME=0
          MEASUREMENTS=3
          for i in $(seq 1 $MEASUREMENTS); do
            TIME_MS=$(curl -sS -o /dev/null -w "%{time_total}" --max-time 15 "${SITE_URL}" 2>/dev/null || echo "0")
            TIME_INT=$(echo "$TIME_MS * 1000" | bc | cut -d. -f1 2>/dev/null || echo "0")
            TOTAL_TIME=$((TOTAL_TIME + TIME_INT))
            echo "  Measurement ${i}: ${TIME_INT}ms"
          done

          AVG_TIME=$((TOTAL_TIME / MEASUREMENTS))
          echo "| Metric | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|--------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Avg Response Time | ${AVG_TIME}ms |" >> "$GITHUB_STEP_SUMMARY"

          if [[ $AVG_TIME -gt 5000 ]]; then
            echo "::warning::Average response time ${AVG_TIME}ms exceeds 5000ms threshold"
          fi

  # ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  # ‚îÇ STAGE 8: NOTIFY ‚Äî Deployment status notification                       ‚îÇ
  # ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  notify:
    name: "üì¢ Notify"
    runs-on: ubuntu-latest
    needs: [preflight, build, quality-gates, deploy, post-deploy]
    if: always() && needs.preflight.outputs.is_deploy == 'true'
    timeout-minutes: 5

    steps:
      - name: "üì¢ Discord notification"
        if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
        run: |
          # Determine overall status
          if [[ "${{ needs.deploy.result }}" == "success" && "${{ needs.post-deploy.result }}" == "success" ]]; then
            STATUS="‚úÖ SUCCESS"
            COLOR=3066993  # Green
            EMOJI="üéâ"
          elif [[ "${{ needs.deploy.result }}" == "success" ]]; then
            STATUS="‚ö†Ô∏è DEPLOYED (verification warnings)"
            COLOR=15105570  # Orange
            EMOJI="‚ö†Ô∏è"
          else
            STATUS="‚ùå FAILED"
            COLOR=15158332  # Red
            EMOJI="üö®"
          fi

          curl -sS -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"${EMOJI} Helix Wiki Deployment\",
                \"description\": \"**Status:** ${STATUS}\",
                \"color\": ${COLOR},
                \"fields\": [
                  {\"name\": \"Build\", \"value\": \"\`${{ needs.preflight.outputs.build_id }}\`\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": \"[\`${{ needs.preflight.outputs.short_sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                  {\"name\": \"Actor\", \"value\": \"\`${{ github.actor }}\`\", \"inline\": true},
                  {\"name\": \"Trigger\", \"value\": \"\`${{ github.event_name }}\`\", \"inline\": true},
                  {\"name\": \"URL\", \"value\": \"${{ env.SITE_URL }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"Fortress CI/CD Pipeline\"},
                \"timestamp\": \"${{ needs.preflight.outputs.build_timestamp }}\"
              }]
            }" || echo "::warning::Discord notification failed (non-critical)"

      - name: "üìù Final pipeline summary"
        if: always()
        run: |
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "---" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "## üè∞ Fortress Pipeline ‚Äî Final Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Stage | Status |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|--------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| üõ´ Preflight | ${{ needs.preflight.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.preflight.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| üèóÔ∏è Build | ${{ needs.build.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.build.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| üéØ Quality Gates | ${{ needs.quality-gates.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} ${{ needs.quality-gates.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| üöÄ Deploy | ${{ needs.deploy.result == 'success' && '‚úÖ' || '‚ùå' }} ${{ needs.deploy.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| üè• Post-Deploy | ${{ needs.post-deploy.result == 'success' && '‚úÖ' || '‚ö†Ô∏è' }} ${{ needs.post-deploy.result }} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Build ID:** \`${{ needs.preflight.outputs.build_id }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "**Commit:** [\`${{ needs.preflight.outputs.short_sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> "$GITHUB_STEP_SUMMARY"
          echo "**Pipeline:** [Run #${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> "$GITHUB_STEP_SUMMARY"
