# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                             â•‘
# â•‘   â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—          â•‘
# â•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘          â•‘
# â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘          â•‘
# â•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘          â•‘
# â•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—    â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘          â•‘
# â•‘   â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•  â•šâ•â•     â•šâ•â•â•â•šâ•â•â• â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•      â•‘
# â•‘                                                                             â•‘
# â•‘   ğŸ”’ PRODUCTION DEPLOYMENT PIPELINE â€” ULTRA SECURE                         â•‘
# â•‘   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â•‘
# â•‘   Pipeline: Security Gate â†’ Quality Gate â†’ Build & Harden â†’ Deploy FTPS    â•‘
# â•‘             â†’ Post-Deploy Verify â†’ Report                                  â•‘
# â•‘   Target:   Hostinger Classic Hosting (FTPS)                               â•‘
# â•‘   Domain:   helix-wiki.com                                                 â•‘
# â•‘                                                                             â•‘
# â•‘   Required Secrets:                                                         â•‘
# â•‘     FTP_SERVER       â€” Hostinger FTPS host/IP                               â•‘
# â•‘     FTP_USERNAME     â€” FTP account username                                 â•‘
# â•‘     FTP_PASSWORD     â€” FTP account password                                 â•‘
# â•‘     FTP_REMOTE_PATH  â€” Remote directory (optional, defaults to ./)          â•‘
# â•‘                                                                             â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deployment (skip cache)"
        required: false
        default: "false"
        type: boolean
      environment:
        description: "Target environment"
        required: false
        default: "production"
        type: choice
        options:
          - production
          - staging

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: "20"
  SITE_URL: "https://helix-wiki.com"

permissions:
  contents: read
  actions: read

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#  STAGE 1 â€” SECURITY GATE
#  Secret scanning â€¢ Dependency audit â€¢ License compliance
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
jobs:
  security:
    name: ğŸ›¡ï¸ Security Gate
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Scan for leaked secrets
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” SECRET SCANNING                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          PATTERNS=(
            'AKIA[0-9A-Z]{16}'                          # AWS Access Key
            'AIza[0-9A-Za-z\-_]{35}'                    # Google API Key
            'sk-[0-9a-zA-Z]{48}'                        # OpenAI API Key
            'ghp_[0-9a-zA-Z]{36}'                       # GitHub PAT
            'glpat-[0-9a-zA-Z\-_]{20}'                  # GitLab PAT
            'xox[baprs]-[0-9a-zA-Z\-]{10,}'            # Slack Token
            'sk_live_[0-9a-zA-Z]{24,}'                  # Stripe Secret Key
            'sq0atp-[0-9A-Za-z\-_]{22}'                 # Square Access Token
            'SG\.[0-9A-Za-z\-_]{22}\.[0-9A-Za-z\-_]{43}' # SendGrid API Key
            '-----BEGIN (RSA |EC )?PRIVATE KEY-----'     # Private Keys
            'mongodb(\+srv)?://[^\s]+'                   # MongoDB URI
            'postgres(ql)?://[^\s]+'                     # PostgreSQL URI
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rPn "$pattern" --include="*.{ts,tsx,js,jsx,json,env,md}" . 2>/dev/null | grep -v node_modules | grep -v '.git/'; then
              echo "  âŒ MATCH: $pattern"
              FOUND=$((FOUND + 1))
            fi
          done

          if [ $FOUND -gt 0 ]; then
            echo ""
            echo "  ğŸš¨ CRITICAL: $FOUND secret pattern(s) detected!"
            echo "  â›” Deployment blocked for security."
            exit 1
          fi

          echo "  âœ… No secrets detected â€” clean repository"

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Audit dependencies
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” DEPENDENCY AUDIT                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo ""
          echo "  ğŸ“Š Dependency tree summary:"
          echo "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          npm ls --depth=0 2>/dev/null | head -20 || true
          echo ""

          # Count total dependencies
          TOTAL=$(npm ls --all --parseable 2>/dev/null | wc -l)
          echo "  ğŸ“¦ Total packages (incl. transitive): $TOTAL"
          echo ""

          # Run audit â€” warn on moderate, fail on critical
          echo "  ğŸ” Running security audit..."
          AUDIT_OUTPUT=$(npm audit --json 2>/dev/null || true)

          CRITICAL=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.critical // 0' 2>/dev/null || echo "0")
          HIGH=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.high // 0' 2>/dev/null || echo "0")
          MODERATE=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.moderate // 0' 2>/dev/null || echo "0")
          LOW=$(echo "$AUDIT_OUTPUT" | jq '.metadata.vulnerabilities.low // 0' 2>/dev/null || echo "0")

          echo ""
          echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "  â”‚  Vulnerability Report            â”‚"
          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "  â”‚  ğŸ”´ Critical:  $CRITICAL                      â”‚"
          echo "  â”‚  ğŸŸ  High:      $HIGH                      â”‚"
          echo "  â”‚  ğŸŸ¡ Moderate:  $MODERATE                      â”‚"
          echo "  â”‚  ğŸŸ¢ Low:       $LOW                      â”‚"
          echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""

          if [ "$CRITICAL" -gt 0 ] 2>/dev/null; then
            echo "  ğŸš¨ CRITICAL vulnerabilities found â€” blocking deploy!"
            npm audit 2>/dev/null || true
            exit 1
          fi

          echo "  âœ… No critical vulnerabilities â€” audit passed"

      - name: ğŸ“œ Check license compliance
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“œ LICENSE COMPLIANCE                â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Banned licenses for production use
          BANNED="GPL-3.0|AGPL|SSPL|EUPL|CC-BY-NC|CC-BY-ND"

          VIOLATIONS=0
          while IFS= read -r line; do
            pkg=$(echo "$line" | cut -d'@' -f1)
            license=$(npm info "$pkg" license 2>/dev/null || echo "UNKNOWN")
            if echo "$license" | grep -qEi "$BANNED"; then
              echo "  âš ï¸  $pkg â†’ $license (RESTRICTED)"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done < <(npm ls --depth=0 --parseable 2>/dev/null | tail -n +2 | xargs -I{} basename {} | head -20)

          if [ $VIOLATIONS -gt 0 ]; then
            echo "  âš ï¸  $VIOLATIONS restricted license(s) found â€” review required"
          else
            echo "  âœ… All licenses compliant"
          fi
        continue-on-error: true

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  #  STAGE 2 â€” QUALITY GATE
  #  ESLint â€¢ TypeScript strict check â€¢ Bundle analysis
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  quality:
    name: âœ¨ Quality Gate
    runs-on: ubuntu-latest
    needs: security
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” ESLint analysis
        continue-on-error: true
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” ESLINT ANALYSIS                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          npx eslint . --format stylish 2>&1 || true

          ERRORS=$(npx eslint . --format json 2>/dev/null | jq '[.[].errorCount] | add // 0' 2>/dev/null || echo "0")
          WARNINGS=$(npx eslint . --format json 2>/dev/null | jq '[.[].warningCount] | add // 0' 2>/dev/null || echo "0")

          echo ""
          echo "  ğŸ“Š Results: $ERRORS error(s), $WARNINGS warning(s)"

          if [ "$ERRORS" -gt 0 ] 2>/dev/null; then
            echo "  âš ï¸  ESLint errors found (non-blocking)"
          else
            echo "  âœ… ESLint passed"
          fi

      - name: ğŸ” TypeScript strict check
        continue-on-error: true
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” TYPESCRIPT STRICT CHECK           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          npx tsc --noEmit 2>&1
          echo "  âœ… Type checking passed â€” zero errors"

      - name: ğŸ“ File size analysis
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“ CODEBASE METRICS                  â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          TS_FILES=$(find . -name '*.ts' -o -name '*.tsx' | grep -v node_modules | grep -v .next | wc -l)
          CSS_FILES=$(find . -name '*.css' | grep -v node_modules | wc -l)
          TOTAL_LINES=$(find . \( -name '*.ts' -o -name '*.tsx' -o -name '*.css' \) ! -path '*/node_modules/*' ! -path '*/.next/*' -exec cat {} + 2>/dev/null | wc -l)
          COMPONENTS=$(find ./components -name '*.tsx' 2>/dev/null | wc -l)
          PAGES=$(find ./app -name 'page.tsx' 2>/dev/null | wc -l)

          echo ""
          echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "  â”‚  Codebase Overview                â”‚"
          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "  â”‚  ğŸ“„ TypeScript files:  $TS_FILES"
          echo "  â”‚  ğŸ¨ CSS files:         $CSS_FILES"
          echo "  â”‚  ğŸ§© Components:        $COMPONENTS"
          echo "  â”‚  ğŸ“‘ Pages:             $PAGES"
          echo "  â”‚  ğŸ“ Total lines:       $TOTAL_LINES"
          echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  #  STAGE 3 â€” BUILD & HARDEN
  #  Next.js static export â€¢ .htaccess hardening â€¢ SBOM â€¢ Build manifest
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  build:
    name: ğŸ”¨ Build & Harden
    runs-on: ubuntu-latest
    needs: quality
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”¨ Build Next.js static export
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”¨ BUILDING STATIC SITE              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          START=$(date +%s)
          npm run build
          END=$(date +%s)
          DURATION=$((END - START))

          echo ""
          PAGE_COUNT=$(find out -name '*.html' 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh out 2>/dev/null | cut -f1)
          JS_SIZE=$(find out -name '*.js' -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1)
          CSS_SIZE=$(find out -name '*.css' -exec du -ch {} + 2>/dev/null | tail -1 | cut -f1)

          echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "  â”‚  Build Results                    â”‚"
          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "  â”‚  â±ï¸  Duration:     ${DURATION}s"
          echo "  â”‚  ğŸ“‘ HTML pages:   $PAGE_COUNT"
          echo "  â”‚  ğŸ“¦ Total size:   $TOTAL_SIZE"
          echo "  â”‚  ğŸ“œ JS bundle:    $JS_SIZE"
          echo "  â”‚  ğŸ¨ CSS bundle:   $CSS_SIZE"
          echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "  âœ… Build successful"
        env:
          CI: false
          NEXT_TELEMETRY_DISABLED: 1
          ESLINT_NO_DEV_ERRORS: true

      - name: ğŸ›¡ï¸ Generate hardened .htaccess
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ›¡ï¸ GENERATING .htaccess              â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          cat > out/.htaccess << 'HTACCESS'
          # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          # â•‘  Helix Wiki â€” Apache Security & Performance Configuration   â•‘
          # â•‘  Auto-generated by CI/CD pipeline â€” DO NOT EDIT MANUALLY    â•‘
          # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          # â”€â”€ HTTPS Force Redirect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          RewriteEngine On
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

          # â”€â”€ WWW â†’ non-WWW redirect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
          RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

          # â”€â”€ Security Headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          <IfModule mod_headers.c>
            # HSTS â€” Force HTTPS for 2 years + subdomains + preload
            Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

            # Prevent MIME type sniffing
            Header always set X-Content-Type-Options "nosniff"

            # Clickjacking protection
            Header always set X-Frame-Options "SAMEORIGIN"

            # XSS Protection (legacy browsers)
            Header always set X-XSS-Protection "1; mode=block"

            # Referrer Policy â€” privacy-conscious
            Header always set Referrer-Policy "strict-origin-when-cross-origin"

            # Permissions Policy â€” disable unnecessary APIs
            Header always set Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"

            # Content Security Policy
            Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https:; connect-src 'self' https:; frame-ancestors 'self'"

            # Prevent information leakage
            Header always unset X-Powered-By
            Header always unset Server
          </IfModule>

          # â”€â”€ Gzip Compression â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE text/javascript
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/json
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE image/svg+xml
            AddOutputFilterByType DEFLATE font/woff2
          </IfModule>

          # â”€â”€ Browser Caching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          <IfModule mod_expires.c>
            ExpiresActive On

            # Static assets â€” aggressive caching (1 year)
            ExpiresByType image/png                 "access plus 1 year"
            ExpiresByType image/jpeg                "access plus 1 year"
            ExpiresByType image/gif                 "access plus 1 year"
            ExpiresByType image/svg+xml             "access plus 1 year"
            ExpiresByType image/webp                "access plus 1 year"
            ExpiresByType image/x-icon              "access plus 1 year"
            ExpiresByType font/woff2                "access plus 1 year"
            ExpiresByType font/woff                 "access plus 1 year"
            ExpiresByType application/font-woff2    "access plus 1 year"

            # JS/CSS â€” cache with revalidation (1 month, Next.js hashes them)
            ExpiresByType text/css                  "access plus 1 month"
            ExpiresByType application/javascript    "access plus 1 month"
            ExpiresByType text/javascript           "access plus 1 month"

            # HTML â€” short cache (10 minutes)
            ExpiresByType text/html                 "access plus 10 minutes"

            # JSON/XML â€” medium cache
            ExpiresByType application/json          "access plus 1 hour"
            ExpiresByType application/xml           "access plus 1 hour"
          </IfModule>

          # â”€â”€ Block Sensitive Files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          <FilesMatch "\.(env|git|gitignore|DS_Store|htpasswd|htaccess\.bak|log|sql|bak|swp|yml|yaml|toml|lock)$">
            Order allow,deny
            Deny from all
          </FilesMatch>

          # Block access to hidden files/directories
          <IfModule mod_rewrite.c>
            RewriteRule (^|/)\.(?!well-known/) - [F]
          </IfModule>

          # â”€â”€ Block Bad Bots & Scanners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          <IfModule mod_rewrite.c>
            RewriteCond %{HTTP_USER_AGENT} (AhrefsBot|MJ12bot|DotBot|SemrushBot|BLEXBot|proximic) [NC]
            RewriteRule .* - [F,L]
          </IfModule>

          # â”€â”€ Custom Error Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          ErrorDocument 404 /404.html
          ErrorDocument 403 /404.html
          ErrorDocument 500 /404.html

          # â”€â”€ Prevent Directory Listing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          Options -Indexes

          # â”€â”€ UTF-8 Default Charset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          AddDefaultCharset UTF-8
          HTACCESS

          # Fix indentation (remove leading spaces from heredoc)
          sed -i 's/^          //' out/.htaccess

          echo "  âœ… .htaccess generated with:"
          echo "     â€¢ HTTPS force redirect"
          echo "     â€¢ HSTS (2 years + preload)"
          echo "     â€¢ CSP headers"
          echo "     â€¢ X-Frame-Options, X-Content-Type-Options"
          echo "     â€¢ Permissions-Policy (camera, mic, geo disabled)"
          echo "     â€¢ Gzip compression"
          echo "     â€¢ Browser caching (assets: 1yr, JS/CSS: 1mo, HTML: 10min)"
          echo "     â€¢ Sensitive file blocking"
          echo "     â€¢ Bad bot blocking"
          echo "     â€¢ Directory listing disabled"

      - name: ğŸ“‹ Generate SBOM (Software Bill of Materials)
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“‹ SOFTWARE BILL OF MATERIALS        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          cat > out/_sbom.json << EOF
          {
            "bomFormat": "HelixCI",
            "specVersion": "1.0",
            "metadata": {
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "component": {
                "name": "helix-wiki",
                "version": "$(jq -r '.version' package.json)",
                "type": "website"
              },
              "pipeline": {
                "id": "${{ github.run_id }}",
                "number": "${{ github.run_number }}",
                "sha": "${{ github.sha }}",
                "ref": "${{ github.ref }}",
                "actor": "${{ github.actor }}"
              }
            },
            "components": $(npm ls --json --depth=0 2>/dev/null | jq '.dependencies // {}' 2>/dev/null || echo '{}')
          }
          EOF

          sed -i 's/^          //' out/_sbom.json
          COMP_COUNT=$(jq '.components | length' out/_sbom.json 2>/dev/null || echo "?")
          echo "  âœ… SBOM generated â€” $COMP_COUNT direct dependencies catalogued"

      - name: ğŸ“Š Generate build manifest
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“Š BUILD MANIFEST                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          HTML_COUNT=$(find out -name '*.html' | wc -l)
          JS_COUNT=$(find out -name '*.js' | wc -l)
          CSS_COUNT=$(find out -name '*.css' | wc -l)
          TOTAL_FILES=$(find out -type f | wc -l)
          TOTAL_SIZE=$(du -sb out | cut -f1)

          cat > out/_build-manifest.json << EOF
          {
            "build": {
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "node_version": "$(node -v)",
              "npm_version": "$(npm -v)",
              "next_version": "$(npx next --version 2>/dev/null || echo 'unknown')",
              "git_sha": "${{ github.sha }}",
              "git_short_sha": "$(echo '${{ github.sha }}' | cut -c1-7)",
              "git_ref": "${{ github.ref_name }}",
              "run_id": "${{ github.run_id }}",
              "run_number": "${{ github.run_number }}",
              "actor": "${{ github.actor }}"
            },
            "output": {
              "html_pages": $HTML_COUNT,
              "js_files": $JS_COUNT,
              "css_files": $CSS_COUNT,
              "total_files": $TOTAL_FILES,
              "total_size_bytes": $TOTAL_SIZE,
              "total_size_human": "$(du -sh out | cut -f1)"
            }
          }
          EOF

          echo "  âœ… Manifest: $HTML_COUNT pages, $TOTAL_FILES files, $(du -sh out | cut -f1)"

      - name: ğŸ”’ Generate file integrity checksums
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”’ FILE INTEGRITY CHECKSUMS          â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          cd out
          find . -type f \
            ! -name '_sbom.json' \
            ! -name '_build-manifest.json' \
            ! -name '_checksums.sha256' \
            -exec sha256sum {} + | sort > _checksums.sha256
          cd ..

          CHECKSUM_COUNT=$(wc -l < out/_checksums.sha256)
          echo "  âœ… SHA-256 checksums generated for $CHECKSUM_COUNT files"

      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: helix-wiki-build-${{ github.sha }}
          path: out/
          retention-days: 7
          if-no-files-found: error

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  #  STAGE 4 â€” DEPLOY VIA FTPS
  #  Secure file transfer to Hostinger production server
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 20
    environment:
      name: production
      url: ${{ env.SITE_URL }}

    steps:
      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: helix-wiki-build-${{ github.sha }}
          path: out/

      - name: ğŸ” Pre-deploy validation
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” PRE-DEPLOY VALIDATION             â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          ERRORS=0

          # Check output directory exists
          if [ ! -d "out" ]; then
            echo "  âŒ Build output directory 'out/' not found!"
            exit 1
          fi

          # Check index.html exists
          if [ ! -f "out/index.html" ]; then
            echo "  âŒ index.html missing from build output!"
            ERRORS=$((ERRORS + 1))
          else
            echo "  âœ… index.html present"
          fi

          # Check 404 page
          if [ -f "out/404.html" ]; then
            echo "  âœ… 404.html present"
          else
            echo "  âš ï¸  404.html missing (non-critical)"
          fi

          # Check .htaccess
          if [ -f "out/.htaccess" ]; then
            echo "  âœ… .htaccess present"
          else
            echo "  âš ï¸  .htaccess missing"
          fi

          # Check no .env files leaked
          if find out -name '.env*' | grep -q .; then
            echo "  âŒ .env file found in build output â€” BLOCKED"
            ERRORS=$((ERRORS + 1))
          else
            echo "  âœ… No .env files in output"
          fi

          # Check no source maps in production
          MAPS=$(find out -name '*.map' | wc -l)
          if [ "$MAPS" -gt 0 ]; then
            echo "  âš ï¸  $MAPS source map(s) found â€” removing for security"
            find out -name '*.map' -delete
            echo "  âœ… Source maps removed"
          else
            echo "  âœ… No source maps"
          fi

          # Check total size
          SIZE_KB=$(du -sk out | cut -f1)
          SIZE_MB=$((SIZE_KB / 1024))
          echo "  ğŸ“¦ Total deploy size: ${SIZE_MB}MB (${SIZE_KB}KB)"

          if [ $SIZE_MB -gt 500 ]; then
            echo "  âŒ Deploy package exceeds 500MB safety limit!"
            ERRORS=$((ERRORS + 1))
          fi

          echo ""
          FILE_COUNT=$(find out -type f | wc -l)
          echo "  ğŸ“Š Files to deploy: $FILE_COUNT"

          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "  ğŸš¨ $ERRORS critical error(s) â€” deploy blocked!"
            exit 1
          fi

          echo ""
          echo "  âœ… All pre-deploy checks passed"

      - name: ğŸš€ Deploy via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ secrets.FTP_REMOTE_PATH || './' }}
          local-dir: ./out/
          protocol: ftps
          log-level: minimal
          dangerous-clean-slate: false

      - name: âœ… Deploy confirmation
        run: |
          echo ""
          echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "  â•‘  ğŸ‰ DEPLOYMENT SUCCESSFUL!            â•‘"
          echo "  â•‘                                       â•‘"
          echo "  â•‘  ğŸŒ ${{ env.SITE_URL }}               â•‘"
          echo "  â•‘  ğŸ“¦ Commit: ${{ github.sha }}         â•‘"
          echo "  â•‘  ğŸ‘¤ Actor:  ${{ github.actor }}       â•‘"
          echo "  â•‘  ğŸ• Time:   $(date -u +%H:%M:%S)UTC  â•‘"
          echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  #  STAGE 5 â€” POST-DEPLOY VERIFICATION
  #  Health checks â€¢ SEO audit â€¢ Security headers â€¢ Performance baseline
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  verify:
    name: âœ… Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 10
    if: success()

    steps:
      - name: â³ Wait for CDN propagation
        run: |
          echo "  â³ Waiting 30s for deployment propagation..."
          sleep 30

      - name: ğŸŒ Health checks
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸŒ HEALTH CHECKS                     â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          SITE="${{ env.SITE_URL }}"
          PASS=0
          FAIL=0
          WARN=0

          check_url() {
            local url="$1"
            local name="$2"
            local expected="${3:-200}"

            STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 -L "$url" 2>/dev/null || echo "000")

            if [ "$STATUS" = "$expected" ]; then
              echo "  âœ… $name â†’ $STATUS"
              PASS=$((PASS + 1))
            elif [ "$STATUS" = "000" ]; then
              echo "  âš ï¸  $name â†’ TIMEOUT"
              WARN=$((WARN + 1))
            else
              echo "  âŒ $name â†’ $STATUS (expected $expected)"
              FAIL=$((FAIL + 1))
            fi
          }

          echo ""
          echo "  â”€â”€ Core Pages â”€â”€"
          check_url "$SITE/"              "Homepage"
          check_url "$SITE/docs/"         "Documentation"
          check_url "$SITE/donate/"       "Donate"
          check_url "$SITE/download/"     "Download"

          echo ""
          echo "  â”€â”€ Documentation Pages â”€â”€"
          check_url "$SITE/docs/architecture/"  "Architecture"
          check_url "$SITE/docs/core/"          "Core"
          check_url "$SITE/docs/filesystem/"    "Filesystem"
          check_url "$SITE/docs/hal/"           "HAL"
          check_url "$SITE/docs/lumina/"        "Lumina"
          check_url "$SITE/docs/modules/"       "Modules"
          check_url "$SITE/docs/nexus/"         "NEXUS"
          check_url "$SITE/docs/subsystems/"    "Subsystems"

          echo ""
          echo "  â”€â”€ Static Assets â”€â”€"
          check_url "$SITE/sitemap.xml"     "Sitemap"
          check_url "$SITE/robots.txt"      "Robots.txt"
          check_url "$SITE/favicon.ico"     "Favicon"
          check_url "$SITE/og-image.png"    "OG Image"
          check_url "$SITE/icon.svg"        "SVG Icon"

          echo ""
          echo "  â”€â”€ Error Handling â”€â”€"
          check_url "$SITE/this-page-does-not-exist-12345/" "404 handling"

          echo ""
          echo "  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "  â”‚  Results                          â”‚"
          echo "  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          echo "  â”‚  âœ… Passed:   $PASS"
          echo "  â”‚  âŒ Failed:   $FAIL"
          echo "  â”‚  âš ï¸  Timeout:  $WARN"
          echo "  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"

          if [ $FAIL -gt 3 ]; then
            echo ""
            echo "  ğŸš¨ Too many failures â€” investigate deployment!"
            exit 1
          fi
        continue-on-error: true

      - name: ğŸ”’ Security headers audit
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”’ SECURITY HEADERS AUDIT            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          SITE="${{ env.SITE_URL }}"
          HEADERS=$(curl -s -I --max-time 15 -L "$SITE" 2>/dev/null || echo "")

          if [ -z "$HEADERS" ]; then
            echo "  âš ï¸  Could not fetch headers (site may not be accessible yet)"
            exit 0
          fi

          SCORE=0
          TOTAL=0

          check_header() {
            local header="$1"
            local name="$2"
            TOTAL=$((TOTAL + 1))

            if echo "$HEADERS" | grep -qi "$header"; then
              echo "  âœ… $name"
              SCORE=$((SCORE + 1))
            else
              echo "  âŒ $name â€” missing"
            fi
          }

          echo ""
          check_header "strict-transport-security"  "HSTS"
          check_header "x-content-type-options"     "X-Content-Type-Options"
          check_header "x-frame-options"            "X-Frame-Options"
          check_header "x-xss-protection"           "X-XSS-Protection"
          check_header "referrer-policy"            "Referrer-Policy"
          check_header "permissions-policy"         "Permissions-Policy"
          check_header "content-security-policy"    "Content-Security-Policy"

          echo ""
          PERCENT=$((SCORE * 100 / TOTAL))
          echo "  ğŸ“Š Security Score: $SCORE/$TOTAL ($PERCENT%)"

          if [ $PERCENT -ge 80 ]; then
            echo "  ğŸ† Grade: A â€” Excellent"
          elif [ $PERCENT -ge 60 ]; then
            echo "  ğŸ“— Grade: B â€” Good"
          elif [ $PERCENT -ge 40 ]; then
            echo "  ğŸ“™ Grade: C â€” Needs Improvement"
          else
            echo "  ğŸ“• Grade: D â€” Poor"
          fi
        continue-on-error: true

      - name: ğŸ” SEO quick audit
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” SEO QUICK AUDIT                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          SITE="${{ env.SITE_URL }}"
          HTML=$(curl -s --max-time 15 -L "$SITE" 2>/dev/null || echo "")

          if [ -z "$HTML" ]; then
            echo "  âš ï¸  Could not fetch homepage"
            exit 0
          fi

          SCORE=0
          TOTAL=0

          check_tag() {
            local pattern="$1"
            local name="$2"
            TOTAL=$((TOTAL + 1))

            if echo "$HTML" | grep -qi "$pattern"; then
              echo "  âœ… $name"
              SCORE=$((SCORE + 1))
            else
              echo "  âŒ $name â€” missing"
            fi
          }

          echo ""
          check_tag '<title'                       "Title tag"
          check_tag 'meta.*description'            "Meta description"
          check_tag 'meta.*viewport'               "Viewport meta"
          check_tag 'link.*canonical'               "Canonical URL"
          check_tag 'meta.*og:title'               "OG: Title"
          check_tag 'meta.*og:description'         "OG: Description"
          check_tag 'meta.*og:image'               "OG: Image"
          check_tag 'meta.*og:url'                 "OG: URL"
          check_tag 'meta.*twitter:card'           "Twitter Card"
          check_tag 'meta.*twitter:title'          "Twitter Title"
          check_tag 'link.*icon'                   "Favicon link"
          check_tag 'html.*lang='                  "HTML lang attribute"
          check_tag 'meta.*theme-color'            "Theme color"

          echo ""
          PERCENT=$((SCORE * 100 / TOTAL))
          echo "  ğŸ“Š SEO Score: $SCORE/$TOTAL ($PERCENT%)"

          if [ $PERCENT -ge 85 ]; then
            echo "  ğŸ† SEO Grade: A â€” Excellent"
          elif [ $PERCENT -ge 70 ]; then
            echo "  ğŸ“— SEO Grade: B â€” Good"
          else
            echo "  ğŸ“™ SEO Grade: C â€” Needs Work"
          fi
        continue-on-error: true

      - name: âš¡ Performance baseline
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âš¡ PERFORMANCE BASELINE               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          SITE="${{ env.SITE_URL }}"

          measure_page() {
            local url="$1"
            local name="$2"

            METRICS=$(curl -s -o /dev/null -w "time_total:%{time_total} time_connect:%{time_connect} time_starttransfer:%{time_starttransfer} size_download:%{size_download}" --max-time 20 -L "$url" 2>/dev/null || echo "")

            if [ -n "$METRICS" ]; then
              TTFB=$(echo "$METRICS" | grep -oP 'time_starttransfer:\K[0-9.]+')
              TOTAL=$(echo "$METRICS" | grep -oP 'time_total:\K[0-9.]+')
              SIZE=$(echo "$METRICS" | grep -oP 'size_download:\K[0-9]+')
              SIZE_KB=$((SIZE / 1024))

              printf "  %-20s TTFB: %ss  Total: %ss  Size: %sKB\n" "$name" "$TTFB" "$TOTAL" "$SIZE_KB"
            else
              printf "  %-20s âš ï¸  Could not measure\n" "$name"
            fi
          }

          echo ""
          measure_page "$SITE/"          "Homepage"
          measure_page "$SITE/docs/"     "Docs Index"
          measure_page "$SITE/donate/"   "Donate"
          measure_page "$SITE/download/" "Download"
          echo ""
          echo "  â„¹ï¸  TTFB < 0.8s = Good | < 1.8s = Needs Improvement | > 1.8s = Poor"
        continue-on-error: true

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  #  STAGE 6 â€” REPORT
  #  GitHub Actions summary â€¢ Deployment record
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  report:
    name: ğŸ“Š Pipeline Report
    runs-on: ubuntu-latest
    needs: [security, quality, build, deploy, verify]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š Generate pipeline summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          # ğŸš€ Helix Wiki â€” Deployment Report

          ## Pipeline Overview

          | Stage | Status |
          |-------|--------|
          | ğŸ›¡ï¸ Security Gate | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | âœ¨ Quality Gate | ${{ needs.quality.result == 'success' && 'âœ… Passed' || needs.quality.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Issues' }} |
          | ğŸ”¨ Build & Harden | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |
          | ğŸš€ Deploy FTPS | ${{ needs.deploy.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }} |
          | âœ… Post-Deploy | ${{ needs.verify.result == 'success' && 'âœ… Verified' || needs.verify.result == 'skipped' && 'â­ï¸ Skipped' || 'âš ï¸ Issues' }} |

          ## Deployment Details

          | Property | Value |
          |----------|-------|
          | ğŸŒ **URL** | [helix-wiki.com](https://helix-wiki.com) |
          | ğŸ“¦ **Commit** | `${{ github.sha }}` |
          | ğŸŒ¿ **Branch** | `${{ github.ref_name }}` |
          | ğŸ‘¤ **Actor** | @${{ github.actor }} |
          | ğŸ”¢ **Run** | #${{ github.run_number }} |
          | ğŸ• **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |

          ## Security Features

          - ğŸ” Secret scanning (12 patterns)
          - ğŸ” Dependency audit (critical = blocking)
          - ğŸ“œ License compliance check
          - ğŸ›¡ï¸ .htaccess hardening (HSTS, CSP, security headers)
          - ğŸ”’ Source map removal
          - ğŸ“‹ SBOM generation
          - ğŸ”’ SHA-256 integrity checksums
          - ğŸš« .env leak protection

          ---

          *Generated by Helix Wiki CI/CD Pipeline v3.0*
          EOF

          echo ""
          echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "  â•‘  ğŸ“Š Pipeline report generated         â•‘"
          echo "  â•‘  View in GitHub Actions â†’ Summary     â•‘"
          echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
