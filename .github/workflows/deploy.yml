# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘                                                                             â•‘
# â•‘   ğŸ§¬  HELIX WIKI â€” PRODUCTION DEPLOYMENT PIPELINE                          â•‘
# â•‘                                                                             â•‘
# â•‘   Target: Hostinger Classic Shared Hosting (FTPS)                           â•‘
# â•‘   Method: Static HTML Export â†’ Encrypted FTP Upload                         â•‘
# â•‘                                                                             â•‘
# â•‘   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â•‘
# â•‘   â”‚ğŸ›¡ GUARD â”‚â”€â–¶â”‚ğŸ”¨ BUILD â”‚â”€â–¶â”‚ğŸ”’ ARMOR â”‚â”€â–¶â”‚ğŸš€ SHIP  â”‚â”€â–¶â”‚âœ… VERIFYâ”‚         â•‘
# â•‘   â”‚ Secrets â”‚  â”‚ Export  â”‚  â”‚.htaccessâ”‚  â”‚  FTPS   â”‚  â”‚ Health  â”‚         â•‘
# â•‘   â”‚ Lint    â”‚  â”‚ Stats   â”‚  â”‚ Headers â”‚  â”‚ Deploy  â”‚  â”‚ SEO     â”‚         â•‘
# â•‘   â”‚ Types   â”‚  â”‚ Hash    â”‚  â”‚ CSP     â”‚  â”‚ Integ.  â”‚  â”‚ Perf    â”‚         â•‘
# â•‘   â”‚ Audit   â”‚  â”‚ SBOM    â”‚  â”‚ Perms   â”‚  â”‚         â”‚  â”‚ Notify  â”‚         â•‘
# â•‘   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â•‘
# â•‘                                                                             â•‘
# â•‘   Security layers:                                                          â•‘
# â•‘     â€¢ Hardened runners (step-security)                                      â•‘
# â•‘     â€¢ Secret scanning (TruffleHog)                                          â•‘
# â•‘     â€¢ Dependency audit (npm audit)                                          â•‘
# â•‘     â€¢ SBOM generation (CycloneDX)                                           â•‘
# â•‘     â€¢ Build integrity (SHA-256 chain)                                       â•‘
# â•‘     â€¢ Auto-generated .htaccess (security headers, CSP, HSTS)               â•‘
# â•‘     â€¢ FTPS-only (TLS 1.2+ encrypted transfer)                              â•‘
# â•‘     â€¢ Post-deploy verification (health, SEO, perf, headers)                â•‘
# â•‘     â€¢ Discord alerting                                                      â•‘
# â•‘                                                                             â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Required GitHub Secrets:
#   FTP_HOST            â€” Hostinger FTP hostname
#   FTP_USERNAME        â€” FTP username
#   FTP_PASSWORD        â€” FTP password
#   FTP_REMOTE_PATH     â€” Remote path (e.g. /public_html)
#   DISCORD_WEBHOOK_URL â€” (optional) Discord notifications
#

name: ğŸ§¬ Deploy Helix Wiki

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      clean_deploy:
        description: "ğŸ§¹ Clean deploy â€” delete ALL remote files before uploading"
        required: false
        type: boolean
        default: false
      dry_run:
        description: "ğŸ§ª Dry run â€” build & verify only, skip FTP upload"
        required: false
        type: boolean
        default: false
      skip_verify:
        description: "â­ï¸ Skip post-deploy verification"
        required: false
        type: boolean
        default: false

# â”€â”€â”€ Permissions: Least privilege â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: read
  actions: read
  deployments: write

# â”€â”€â”€ Concurrency: One deploy at a time â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: helix-wiki-production
  cancel-in-progress: true

env:
  NODE_VERSION: "22"
  NEXT_TELEMETRY_DISABLED: "1"
  SITE_URL: "https://helix-wiki.com"
  SITE_NAME: "Helix Wiki"

# =============================================================================
#   J O B S
# =============================================================================

jobs:

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
  # â”ƒ  ğŸ›¡ï¸  STAGE 1 â€” SECURITY GATE                                           â”ƒ
  # â”ƒ  Secret scanning â€¢ Lint â€¢ TypeScript â€¢ Dependency audit                 â”ƒ
  # â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
  security-gate:
    name: ğŸ›¡ï¸ Security Gate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    outputs:
      should-deploy: ${{ steps.changes.outputs.should-deploy }}
      audit-status: ${{ steps.audit.outputs.status }}
    steps:
      - name: ğŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          disable-sudo: true

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          persist-credentials: false

      # â”€â”€ Change Detection â”€â”€
      - name: ğŸ” Detect deployment-relevant changes
        id: changes
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” CHANGE DETECTION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          CHANGED=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "FIRST_PUSH")

          # Skip pattern â€” ONLY these files are truly irrelevant to deployment
          SKIP_PATTERN='^\.(git|husky)|^\.vscode/|^docker|^Dockerfile|^Makefile$|^justfile$|^\.editorconfig$'

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should-deploy=true" >> "$GITHUB_OUTPUT"
            echo "  âœ… Manual trigger â€” deploying"
          elif [ "$CHANGED" = "FIRST_PUSH" ]; then
            echo "should-deploy=true" >> "$GITHUB_OUTPUT"
            echo "  âœ… First push â€” deploying"
          else
            # Deploy unless ALL changed files match the skip pattern
            RELEVANT=$(echo "$CHANGED" | grep -vE "$SKIP_PATTERN" || true)
            if [ -n "$RELEVANT" ]; then
              echo "should-deploy=true" >> "$GITHUB_OUTPUT"
              echo "  âœ… Deployment-relevant changes detected:"
              echo "$RELEVANT" | head -20 | sed 's/^/     /'
            else
              echo "should-deploy=false" >> "$GITHUB_OUTPUT"
              echo "  â­ï¸  Only irrelevant files changed â€” skipping"
              echo "$CHANGED" | head -10 | sed 's/^/     /'
            fi
          fi

      # â”€â”€ Secret Scanning â”€â”€
      - name: ğŸ”’ TruffleHog â€” scan for leaked secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified

      # â”€â”€ Node.js Setup â”€â”€
      - name: ğŸ“¦ Setup Node.js ${{ env.NODE_VERSION }}
        if: steps.changes.outputs.should-deploy == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ğŸ“‹ Install dependencies
        if: steps.changes.outputs.should-deploy == 'true'
        run: npm ci --ignore-scripts

      # â”€â”€ Dependency Audit â”€â”€
      - name: ğŸ” npm audit â€” vulnerability scan
        id: audit
        if: steps.changes.outputs.should-deploy == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” DEPENDENCY AUDIT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          if npm audit --omit=dev --audit-level=critical 2>&1; then
            echo "status=clean" >> "$GITHUB_OUTPUT"
            echo "  âœ… No critical vulnerabilities"
          else
            echo "status=warnings" >> "$GITHUB_OUTPUT"
            echo "  âš ï¸  Vulnerabilities found (non-blocking)"
          fi
        continue-on-error: true

      # â”€â”€ Linting â”€â”€
      - name: ğŸ” ESLint
        if: steps.changes.outputs.should-deploy == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” ESLINT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          npx eslint . --max-warnings 0
        continue-on-error: true

      # â”€â”€ Type Checking â”€â”€
      - name: ğŸ” TypeScript strict check
        if: steps.changes.outputs.should-deploy == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” TYPESCRIPT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          npx tsc --noEmit
          echo "  âœ… Type checking passed"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
  # â”ƒ  ğŸ”¨  STAGE 2 â€” BUILD & HARDEN                                          â”ƒ
  # â”ƒ  Next.js export â€¢ .htaccess â€¢ SBOM â€¢ Integrity hash                    â”ƒ
  # â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
  build:
    name: ğŸ”¨ Build & Harden
    runs-on: ubuntu-latest
    needs: security-gate
    if: needs.security-gate.outputs.should-deploy == 'true'
    permissions:
      contents: read
    outputs:
      build-hash: ${{ steps.integrity.outputs.sha256 }}
      build-size: ${{ steps.stats.outputs.size }}
      page-count: ${{ steps.stats.outputs.pages }}
      file-count: ${{ steps.stats.outputs.files }}
      timestamp:  ${{ steps.meta.outputs.timestamp }}
    steps:
      - name: ğŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          disable-sudo: true

      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: ğŸ“‹ Install dependencies
        run: npm ci

      - name: ğŸ·ï¸ Build metadata
        id: meta
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "timestamp=$TIMESTAMP" >> "$GITHUB_OUTPUT"
          echo "  ğŸ“… Build: $TIMESTAMP"
          echo "  ğŸ”— Commit: ${GITHUB_SHA::8}"
          echo "  ğŸ‘¤ Actor: ${{ github.actor }}"

      # â”€â”€ Next.js Static Build â”€â”€
      - name: ğŸ”¨ Next.js static export
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ”¨ BUILDING STATIC SITE"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          npx next build
        env:
          NODE_ENV: production

      # â”€â”€ Generate hardened .htaccess â”€â”€
      - name: ğŸ”’ Generate .htaccess (security hardening)
        run: |
          cat > out/.htaccess << 'HTACCESS'
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          # Helix Wiki â€” Hardened .htaccess for Hostinger Shared Hosting
          # Auto-generated by CI/CD pipeline â€” DO NOT EDIT MANUALLY
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          # â”€â”€ Engine â”€â”€
          RewriteEngine On

          # â”€â”€ Force HTTPS â”€â”€
          RewriteCond %{HTTPS} off
          RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

          # â”€â”€ Remove www â”€â”€
          RewriteCond %{HTTP_HOST} ^www\.(.+)$ [NC]
          RewriteRule ^(.*)$ https://%1/$1 [R=301,L]

          # â”€â”€ Security Headers â”€â”€
          <IfModule mod_headers.c>
              # HSTS â€” force HTTPS for 1 year, include subdomains
              Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

              # Prevent MIME-type sniffing
              Header always set X-Content-Type-Options "nosniff"

              # Clickjacking protection
              Header always set X-Frame-Options "SAMEORIGIN"

              # XSS filter
              Header always set X-XSS-Protection "1; mode=block"

              # Referrer policy
              Header always set Referrer-Policy "strict-origin-when-cross-origin"

              # Permissions policy
              Header always set Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"

              # Content Security Policy
              Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https:; frame-ancestors 'self';"

              # Remove server identification
              Header always unset X-Powered-By
              Header always unset Server
          </IfModule>

          # â”€â”€ Compression â”€â”€
          <IfModule mod_deflate.c>
              AddOutputFilterByType DEFLATE text/html
              AddOutputFilterByType DEFLATE text/css
              AddOutputFilterByType DEFLATE text/javascript
              AddOutputFilterByType DEFLATE application/javascript
              AddOutputFilterByType DEFLATE application/json
              AddOutputFilterByType DEFLATE application/xml
              AddOutputFilterByType DEFLATE image/svg+xml
              AddOutputFilterByType DEFLATE text/xml
              AddOutputFilterByType DEFLATE text/plain
          </IfModule>

          # â”€â”€ Browser Caching â”€â”€
          <IfModule mod_expires.c>
              ExpiresActive On

              # HTML â€” short cache (deploy updates frequently)
              ExpiresByType text/html "access plus 1 hour"

              # CSS & JS â€” hashed filenames, long cache
              ExpiresByType text/css "access plus 1 year"
              ExpiresByType application/javascript "access plus 1 year"
              ExpiresByType text/javascript "access plus 1 year"

              # Images â€” long cache
              ExpiresByType image/png "access plus 1 year"
              ExpiresByType image/svg+xml "access plus 1 year"
              ExpiresByType image/x-icon "access plus 1 year"
              ExpiresByType image/webp "access plus 1 year"

              # Fonts
              ExpiresByType font/woff2 "access plus 1 year"
              ExpiresByType font/woff "access plus 1 year"

              # XML / JSON
              ExpiresByType application/xml "access plus 1 hour"
              ExpiresByType application/json "access plus 1 hour"
          </IfModule>

          # â”€â”€ ETag (disable for static files â€” use Expires instead) â”€â”€
          <IfModule mod_headers.c>
              Header unset ETag
          </IfModule>
          FileETag None

          # â”€â”€ Block sensitive files â”€â”€
          <FilesMatch "\.(env|log|bak|sql|git|gitignore|md|yml|yaml|toml|lock|ts)$">
              <IfModule mod_authz_core.c>
                  Require all denied
              </IfModule>
          </FilesMatch>

          # â”€â”€ Block directory listing â”€â”€
          Options -Indexes

          # â”€â”€ Custom error pages â”€â”€
          ErrorDocument 404 /404.html

          # â”€â”€ UTF-8 default charset â”€â”€
          AddDefaultCharset UTF-8

          HTACCESS

          echo "  ğŸ”’ .htaccess generated with:"
          echo "     â€¢ HTTPS redirect"
          echo "     â€¢ HSTS (1 year, preload)"
          echo "     â€¢ CSP (Content Security Policy)"
          echo "     â€¢ X-Frame-Options / X-Content-Type-Options"
          echo "     â€¢ Gzip compression"
          echo "     â€¢ Browser caching (1y for assets)"
          echo "     â€¢ Sensitive file blocking"
          echo "     â€¢ Directory listing disabled"
          echo "     â€¢ Custom 404 page"

      # â”€â”€ Build Statistics â”€â”€
      - name: ğŸ“Š Build statistics
        id: stats
        run: |
          SIZE=$(du -sh out/ | cut -f1)
          PAGES=$(find out -name 'index.html' | wc -l)
          FILES=$(find out -type f | wc -l)
          HTML=$(find out -name '*.html' | wc -l)
          JS=$(find out -name '*.js' | wc -l)
          CSS=$(find out -name '*.css' | wc -l)

          echo "size=$SIZE" >> "$GITHUB_OUTPUT"
          echo "pages=$PAGES" >> "$GITHUB_OUTPUT"
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“Š BUILD REPORT                                â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          printf "â•‘  %-14s %-33s â•‘\n" "Total Size:" "$SIZE"
          printf "â•‘  %-14s %-33s â•‘\n" "Pages:" "$PAGES"
          printf "â•‘  %-14s %-33s â•‘\n" "Total Files:" "$FILES"
          printf "â•‘  %-14s %-33s â•‘\n" "HTML:" "$HTML"
          printf "â•‘  %-14s %-33s â•‘\n" "JavaScript:" "$JS"
          printf "â•‘  %-14s %-33s â•‘\n" "CSS:" "$CSS"
          printf "â•‘  %-14s %-33s â•‘\n" "Node.js:" "$(node -v)"
          printf "â•‘  %-14s %-33s â•‘\n" "Next.js:" "$(npx next --version 2>/dev/null || echo 'N/A')"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo ""
          echo "ğŸ“„ Generated pages:"
          find out -name 'index.html' | sort | sed 's|out/||; s|/index.html||; s|^index.html|/ (home)|' | while read -r p; do
            echo "   âœ… /${p}"
          done

      # â”€â”€ SBOM (Software Bill of Materials) â”€â”€
      - name: ğŸ“¦ Generate SBOM
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ“¦ SOFTWARE BILL OF MATERIALS"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Lightweight SBOM â€” list production dependencies
          node -e "
            const pkg = require('./package.json');
            const deps = Object.entries(pkg.dependencies || {});
            const devDeps = Object.entries(pkg.devDependencies || {});
            console.log('Production dependencies: ' + deps.length);
            deps.forEach(([n, v]) => console.log('  ğŸ“¦ ' + n + ' @ ' + v));
            console.log('Dev dependencies: ' + devDeps.length);
          "

          # Save SBOM artifact
          npm ls --json --omit=dev > out/_sbom.json 2>/dev/null || true
          echo ""
          echo "  âœ… SBOM saved to _sbom.json"

      # â”€â”€ Build Integrity Hash â”€â”€
      - name: ğŸ” Generate build integrity hash
        id: integrity
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” BUILD INTEGRITY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          HASH=$(find out -type f -not -name '_sbom.json' -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          echo "sha256=$HASH" >> "$GITHUB_OUTPUT"

          echo "  Algorithm:  SHA-256"
          echo "  Scope:      out/ (all files)"
          echo "  Hash:       $HASH"

          # Save build manifest
          cat > out/_build-manifest.json << MANIFEST
          {
            "version": "1.0",
            "commit": "${{ github.sha }}",
            "ref": "${{ github.ref_name }}",
            "actor": "${{ github.actor }}",
            "timestamp": "${{ steps.meta.outputs.timestamp }}",
            "integrity": "$HASH",
            "node": "$(node -v)",
            "pipeline": "${{ github.run_id }}"
          }
          MANIFEST
          echo "  âœ… Build manifest saved"

      # â”€â”€ Upload Artifact â”€â”€
      - name: ğŸ“¤ Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: helix-wiki-${{ github.sha }}
          path: out/
          retention-days: 14
          compression-level: 6

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
  # â”ƒ  ğŸš€  STAGE 3 â€” DEPLOY VIA FTPS                                         â”ƒ
  # â”ƒ  Integrity verification â€¢ Encrypted upload â€¢ Inventory                  â”ƒ
  # â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [security-gate, build]
    if: |
      needs.security-gate.outputs.should-deploy == 'true' &&
      github.event.inputs.dry_run != 'true'
    environment:
      name: production
      url: ${{ env.SITE_URL }}
    permissions:
      contents: read
      deployments: write
    steps:
      - name: ğŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      # â”€â”€ Download artifact â”€â”€
      - name: ğŸ“¥ Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: helix-wiki-${{ github.sha }}
          path: out/

      # â”€â”€ Integrity Verification â”€â”€
      - name: ğŸ” Verify build integrity (SHA-256 chain)
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” INTEGRITY VERIFICATION"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          HASH=$(find out -type f -not -name '_sbom.json' -exec sha256sum {} \; | sort | sha256sum | cut -d' ' -f1)
          EXPECTED="${{ needs.build.outputs.build-hash }}"

          echo "  Expected: $EXPECTED"
          echo "  Computed: $HASH"

          if [ "$HASH" != "$EXPECTED" ]; then
            echo ""
            echo "  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
            echo "  â•‘  âŒ INTEGRITY CHECK FAILED               â•‘"
            echo "  â•‘  Artifact may have been tampered with!   â•‘"
            echo "  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            exit 1
          fi

          echo ""
          echo "  âœ… Integrity chain intact â€” artifact is authentic"

      # â”€â”€ Pre-deploy Inventory â”€â”€
      - name: ğŸ“‹ Pre-deploy inventory
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ“‹ DEPLOYMENT INVENTORY"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          printf "  %-18s %s\n" "Total files:" "$(find out -type f | wc -l)"
          printf "  %-18s %s\n" "HTML pages:" "$(find out -name '*.html' | wc -l)"
          printf "  %-18s %s\n" "JavaScript:" "$(find out -name '*.js' | wc -l)"
          printf "  %-18s %s\n" "Stylesheets:" "$(find out -name '*.css' | wc -l)"
          printf "  %-18s %s\n" "Images:" "$(find out \( -name '*.png' -o -name '*.svg' -o -name '*.ico' -o -name '*.webp' \) | wc -l)"
          printf "  %-18s %s\n" "Config:" "$(find out \( -name '*.xml' -o -name '*.txt' -o -name '.htaccess' \) | wc -l)"
          echo ""

          # Verify critical files exist
          CRITICAL=(".htaccess" "index.html" "robots.txt" "sitemap.xml" "icon.svg" "og-image.png" "favicon.ico")
          echo "  Critical files:"
          ALL_OK=true
          for f in "${CRITICAL[@]}"; do
            if find out -name "$f" -print -quit | grep -q .; then
              echo "    âœ… $f"
            else
              echo "    âŒ $f â€” MISSING"
              ALL_OK=false
            fi
          done

          if [ "$ALL_OK" = false ]; then
            echo ""
            echo "::warning::Some critical files are missing from the build"
          fi

      # â”€â”€ Remove internal artifacts before upload â”€â”€
      - name: ğŸ§¹ Clean internal files
        run: |
          rm -f out/_sbom.json out/_build-manifest.json
          echo "  ğŸ§¹ Removed internal build artifacts"

      # â”€â”€ FTPS Deploy â”€â”€
      - name: ğŸš€ Deploy to Hostinger via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: out/
          server-dir: ${{ secrets.FTP_REMOTE_PATH }}/
          protocol: ftps
          port: 21
          timeout: 600000
          log-level: minimal
          dangerous-clean-slate: ${{ github.event.inputs.clean_deploy == 'true' }}
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env*

      # â”€â”€ Deploy Report â”€â”€
      - name: ğŸ“ Deploy report
        run: |
          echo ""
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸš€ DEPLOYMENT COMPLETE                         â•‘"
          echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          printf "â•‘  %-14s %-33s â•‘\n" "Method:" "FTPS (TLS encrypted)"
          printf "â•‘  %-14s %-33s â•‘\n" "Host:" "Hostinger Classic"
          printf "â•‘  %-14s %-33s â•‘\n" "Files:" "${{ needs.build.outputs.file-count }}"
          printf "â•‘  %-14s %-33s â•‘\n" "Pages:" "${{ needs.build.outputs.page-count }}"
          printf "â•‘  %-14s %-33s â•‘\n" "Size:" "${{ needs.build.outputs.build-size }}"
          printf "â•‘  %-14s %-33s â•‘\n" "Commit:" "${GITHUB_SHA::8}"
          printf "â•‘  %-14s %-33s â•‘\n" "Integrity:" "âœ… SHA-256 verified"
          printf "â•‘  %-14s %-33s â•‘\n" "Hardened:" "âœ… .htaccess deployed"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
  # â”ƒ  âœ…  STAGE 4 â€” POST-DEPLOY VERIFICATION                                â”ƒ
  # â”ƒ  Health checks â€¢ SEO â€¢ Performance â€¢ Security headers                   â”ƒ
  # â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
  verify:
    name: âœ… Verify
    runs-on: ubuntu-latest
    needs: deploy
    if: github.event.inputs.skip_verify != 'true'
    permissions:
      contents: read
    steps:
      - name: ğŸ” Harden Runner
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit
          disable-sudo: true

      - name: â³ Wait for propagation
        run: |
          echo "  â³ Waiting 20s for DNS/CDN propagation..."
          sleep 20

      # â”€â”€ Health Checks â”€â”€
      - name: ğŸŒ Health checks â€” all pages
        id: health
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸŒ HEALTH CHECKS                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          PASSED=0
          FAILED=0
          TOTAL=0

          check() {
            local name="$1" url="$2" expect="$3"
            TOTAL=$((TOTAL + 1))
            STATUS=$(curl -sL -o /dev/null -w "%{http_code}" --connect-timeout 15 --max-time 30 "$url" 2>/dev/null || echo "000")
            if [ "$STATUS" = "$expect" ]; then
              printf "  âœ… %-28s HTTP %s\n" "$name" "$STATUS"
              PASSED=$((PASSED + 1))
            else
              printf "  âŒ %-28s HTTP %s (expected %s)\n" "$name" "$STATUS" "$expect"
              FAILED=$((FAILED + 1))
            fi
          }

          echo "  â”€â”€ Pages â”€â”€"
          check "Homepage"         "${{ env.SITE_URL }}/"                     "200"
          check "Docs Hub"         "${{ env.SITE_URL }}/docs/"               "200"
          check "Architecture"     "${{ env.SITE_URL }}/docs/architecture/"   "200"
          check "Core"             "${{ env.SITE_URL }}/docs/core/"           "200"
          check "HAL"              "${{ env.SITE_URL }}/docs/hal/"            "200"
          check "Subsystems"       "${{ env.SITE_URL }}/docs/subsystems/"     "200"
          check "Modules"          "${{ env.SITE_URL }}/docs/modules/"        "200"
          check "Filesystem"       "${{ env.SITE_URL }}/docs/filesystem/"     "200"
          check "NEXUS"            "${{ env.SITE_URL }}/docs/nexus/"          "200"
          check "Lumina"           "${{ env.SITE_URL }}/docs/lumina/"         "200"
          check "Donate"           "${{ env.SITE_URL }}/donate/"              "200"
          check "Download"         "${{ env.SITE_URL }}/download/"            "200"

          echo ""
          echo "  â”€â”€ Assets â”€â”€"
          check "robots.txt"       "${{ env.SITE_URL }}/robots.txt"          "200"
          check "sitemap.xml"      "${{ env.SITE_URL }}/sitemap.xml"         "200"
          check "Favicon SVG"      "${{ env.SITE_URL }}/icon.svg"            "200"
          check "Favicon ICO"      "${{ env.SITE_URL }}/favicon.ico"         "200"
          check "OG Image"         "${{ env.SITE_URL }}/og-image.png"        "200"
          check "Apple Icon"       "${{ env.SITE_URL }}/apple-icon.png"      "200"

          echo ""
          echo "  â”€â”€ HTTPS â”€â”€"
          check "HTTPS redirect"   "http://helix-wiki.com/"                  "200"

          echo ""
          SCORE=$((PASSED * 100 / TOTAL))
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          printf "â•‘  âœ… Passed: %-6s  âŒ Failed: %-6s  Score: %s%%  â•‘\n" "$PASSED" "$FAILED" "$SCORE"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          echo "health-passed=$PASSED" >> "$GITHUB_OUTPUT"
          echo "health-failed=$FAILED" >> "$GITHUB_OUTPUT"
          echo "health-score=$SCORE" >> "$GITHUB_OUTPUT"

          if [ "$FAILED" -gt 3 ]; then
            echo "::error::$FAILED health check(s) failed â€” deployment may be broken"
            exit 1
          elif [ "$FAILED" -gt 0 ]; then
            echo "::warning::$FAILED health check(s) failed"
          fi

      # â”€â”€ SEO Verification â”€â”€
      - name: ğŸ” SEO audit
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ” SEO AUDIT                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          HTML=$(curl -sL --max-time 30 "${{ env.SITE_URL }}/")
          PASS=0
          TOTAL=0

          seo() {
            local tag="$1" pattern="$2"
            TOTAL=$((TOTAL + 1))
            if echo "$HTML" | grep -qi "$pattern"; then
              printf "  âœ… %-30s\n" "$tag"
              PASS=$((PASS + 1))
            else
              printf "  âŒ %-30s\n" "$tag"
            fi
          }

          seo "<title>"                    "<title>"
          seo "Meta description"           'name="description"'
          seo "Open Graph: title"          'property="og:title"'
          seo "Open Graph: description"    'property="og:description"'
          seo "Open Graph: image"          'property="og:image"'
          seo "Open Graph: url"            'property="og:url"'
          seo "Open Graph: type"           'property="og:type"'
          seo "Twitter: card"              'name="twitter:card"'
          seo "Twitter: title"             'name="twitter:title"'
          seo "Canonical URL"              'rel="canonical"'
          seo "Favicon link"               'rel="icon"'
          seo "JSON-LD structured data"    'application/ld+json'
          seo "Viewport meta"              'name="viewport"'

          echo ""
          SCORE=$((PASS * 100 / TOTAL))
          echo "  ğŸ“ˆ SEO Score: $PASS/$TOTAL ($SCORE%)"

          if [ "$SCORE" -lt 70 ]; then
            echo "::warning::SEO score is below 70%"
          fi

      # â”€â”€ Performance Baseline â”€â”€
      - name: âš¡ Performance baseline
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  âš¡ RESPONSE TIMES                               â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          TOTAL_MS=0
          COUNT=0

          perf() {
            local path="$1"
            TIME=$(curl -sL -o /dev/null -w "%{time_total}" --connect-timeout 10 --max-time 15 "${{ env.SITE_URL }}$path" 2>/dev/null || echo "0")
            MS=$(echo "$TIME * 1000" | bc 2>/dev/null | cut -d'.' -f1)
            [ -z "$MS" ] && MS=0
            TOTAL_MS=$((TOTAL_MS + MS))
            COUNT=$((COUNT + 1))

            if [ "$MS" -lt 500 ]; then
              printf "  âš¡ %-25s %4sms\n" "$path" "$MS"
            elif [ "$MS" -lt 1500 ]; then
              printf "  ğŸŸ¡ %-25s %4sms\n" "$path" "$MS"
            else
              printf "  ğŸ”´ %-25s %4sms\n" "$path" "$MS"
            fi
          }

          perf "/"
          perf "/docs/"
          perf "/docs/architecture/"
          perf "/docs/core/"
          perf "/donate/"
          perf "/download/"

          if [ "$COUNT" -gt 0 ]; then
            AVG=$((TOTAL_MS / COUNT))
            echo ""
            echo "  ğŸ“Š Average: ${AVG}ms across $COUNT pages"
          fi

      # â”€â”€ Security Headers Check â”€â”€
      - name: ğŸ”’ Security headers verification
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ”’ SECURITY HEADERS                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          HEADERS=$(curl -sI --max-time 15 "${{ env.SITE_URL }}/" 2>/dev/null)
          PASS=0
          TOTAL=0

          sec() {
            local name="$1" pattern="$2"
            TOTAL=$((TOTAL + 1))
            if echo "$HEADERS" | grep -qi "$pattern"; then
              printf "  âœ… %-35s\n" "$name"
              PASS=$((PASS + 1))
            else
              printf "  âš ï¸  %-35s\n" "$name (missing)"
            fi
          }

          sec "Strict-Transport-Security"    "strict-transport-security"
          sec "X-Content-Type-Options"       "x-content-type-options"
          sec "X-Frame-Options"              "x-frame-options"
          sec "X-XSS-Protection"             "x-xss-protection"
          sec "Content-Security-Policy"      "content-security-policy"
          sec "Referrer-Policy"              "referrer-policy"
          sec "Permissions-Policy"           "permissions-policy"

          echo ""
          SCORE=$((PASS * 100 / TOTAL))
          echo "  ğŸ›¡ï¸ Security Score: $PASS/$TOTAL ($SCORE%)"

          if [ "$SCORE" -lt 50 ]; then
            echo "::warning::Security headers score below 50%"
          fi

      # â”€â”€ Content Verification â”€â”€
      - name: ğŸ“„ Content integrity
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ“„ CONTENT VERIFICATION                        â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""

          HTML=$(curl -sL --max-time 15 "${{ env.SITE_URL }}/")

          # Check that key content rendered
          CHECKS=(
            "Helix:Helix brand"
            "kernel:Kernel content"
            "docs:Documentation links"
          )

          for entry in "${CHECKS[@]}"; do
            PATTERN="${entry%%:*}"
            LABEL="${entry##*:}"
            if echo "$HTML" | grep -qi "$PATTERN"; then
              printf "  âœ… %-30s\n" "$LABEL"
            else
              printf "  âŒ %-30s\n" "$LABEL"
            fi
          done

          # Check page size (should be reasonable)
          SIZE=$(echo "$HTML" | wc -c)
          SIZE_KB=$((SIZE / 1024))
          echo ""
          echo "  ğŸ“ Homepage size: ${SIZE_KB}KB"
          if [ "$SIZE_KB" -lt 5 ]; then
            echo "::warning::Homepage is suspiciously small (${SIZE_KB}KB)"
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
  # â”ƒ  ğŸ“¢  STAGE 5 â€” NOTIFICATIONS & REPORT                                  â”ƒ
  # â”ƒ  Discord webhook â€¢ GitHub Actions summary                               â”ƒ
  # â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
  notify:
    name: ğŸ“¢ Report
    runs-on: ubuntu-latest
    needs: [security-gate, build, deploy, verify]
    if: always()
    permissions:
      contents: read
    steps:

      # â”€â”€ Discord Notification â”€â”€
      - name: ğŸ“¢ Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "â„¹ï¸  No Discord webhook configured â€” skipping"
            exit 0
          fi

          DEPLOY="${{ needs.deploy.result }}"
          VERIFY="${{ needs.verify.result }}"
          AUDIT="${{ needs.security-gate.outputs.audit-status }}"

          if [ "$DEPLOY" = "success" ] && [ "$VERIFY" != "failure" ]; then
            COLOR=3066993
            EMOJI="âœ…"
            TITLE="Helix Wiki â€” Deployed Successfully"
            DESC="Static site deployed to Hostinger via FTPS.\n\nğŸ”’ All security checks passed."
            STATUS_FIELD="âœ… Live"
          elif [ "$DEPLOY" = "skipped" ]; then
            COLOR=16776960
            EMOJI="â­ï¸"
            TITLE="Helix Wiki â€” Deployment Skipped"
            DESC="No relevant changes detected."
            STATUS_FIELD="â­ï¸ Skipped"
          else
            COLOR=15158332
            EMOJI="âŒ"
            TITLE="Helix Wiki â€” Deployment Failed"
            DESC="Pipeline encountered an error. Check workflow logs."
            STATUS_FIELD="âŒ Failed"
          fi

          AUDIT_EMOJI="âœ…"
          [ "$AUDIT" = "warnings" ] && AUDIT_EMOJI="âš ï¸"

          curl -sf -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$EMOJI $TITLE\",
                \"description\": \"$DESC\",
                \"color\": $COLOR,
                \"fields\": [
                  { \"name\": \"Status\", \"value\": \"$STATUS_FIELD\", \"inline\": true },
                  { \"name\": \"Commit\", \"value\": \"\`${GITHUB_SHA::8}\`\", \"inline\": true },
                  { \"name\": \"Author\", \"value\": \"${{ github.actor }}\", \"inline\": true },
                  { \"name\": \"Build\", \"value\": \"${{ needs.build.outputs.page-count }} pages Â· ${{ needs.build.outputs.file-count }} files Â· ${{ needs.build.outputs.build-size }}\", \"inline\": false },
                  { \"name\": \"Security\", \"value\": \"$AUDIT_EMOJI Audit Â· âœ… TruffleHog Â· âœ… Integrity Â· ğŸ”’ FTPS\", \"inline\": false },
                  { \"name\": \"Site\", \"value\": \"[${{ env.SITE_URL }}](${{ env.SITE_URL }})\", \"inline\": false }
                ],
                \"footer\": { \"text\": \"Helix Wiki CI/CD â€¢ Pipeline #${{ github.run_number }}\" },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK_URL" || echo "âš ï¸  Discord notification failed (non-critical)"

      # â”€â”€ GitHub Summary â”€â”€
      - name: ğŸ“ Pipeline summary
        if: always()
        run: |
          DEPLOY="${{ needs.deploy.result }}"
          VERIFY="${{ needs.verify.result }}"
          AUDIT="${{ needs.security-gate.outputs.audit-status }}"

          if [ "$DEPLOY" = "success" ]; then
            STATUS_ICON="âœ…"
            STATUS_TEXT="Deployed"
          elif [ "$DEPLOY" = "skipped" ]; then
            STATUS_ICON="â­ï¸"
            STATUS_TEXT="Skipped"
          else
            STATUS_ICON="âŒ"
            STATUS_TEXT="Failed"
          fi

          AUDIT_ICON="âœ…"
          [ "$AUDIT" = "warnings" ] && AUDIT_ICON="âš ï¸"

          cat >> "$GITHUB_STEP_SUMMARY" << EOF

          # ğŸ§¬ Helix Wiki â€” Deployment Report

          ## $STATUS_ICON Status: $STATUS_TEXT

          | Detail | Value |
          |--------|-------|
          | **Method** | FTPS (TLS encrypted) |
          | **Host** | Hostinger Classic |
          | **URL** | [${{ env.SITE_URL }}](${{ env.SITE_URL }}) |
          | **Commit** | \`${{ github.sha }}\` |
          | **Branch** | \`${{ github.ref_name }}\` |
          | **Actor** | @${{ github.actor }} |
          | **Trigger** | \`${{ github.event_name }}\` |
          | **Pipeline** | #${{ github.run_number }} |
          | **Timestamp** | ${{ needs.build.outputs.timestamp }} |

          ## ğŸ“Š Build

          | Metric | Value |
          |--------|-------|
          | Pages | ${{ needs.build.outputs.page-count }} |
          | Files | ${{ needs.build.outputs.file-count }} |
          | Size | ${{ needs.build.outputs.build-size }} |
          | Integrity | \`${{ needs.build.outputs.build-hash }}\` |

          ## ğŸ”’ Security Checklist

          | Check | Status |
          |-------|--------|
          | Hardened runners | âœ… All stages |
          | Secret scanning (TruffleHog) | âœ… Passed |
          | Dependency audit | $AUDIT_ICON $([ "$AUDIT" = "clean" ] && echo "Clean" || echo "Warnings") |
          | TypeScript strict | âœ… Passed |
          | Build integrity (SHA-256) | âœ… Verified |
          | FTPS encrypted transfer | âœ… TLS |
          | .htaccess hardening | âœ… Deployed |
          | HSTS / CSP / X-Frame | âœ… Configured |
          | Health checks | $([ "$VERIFY" = "success" ] && echo "âœ… Passed" || echo "âš ï¸ $VERIFY") |

          ---
          *Generated by the Helix Wiki CI/CD pipeline*

          EOF
